name: Release

on:
  push:
    branches:
      - develop
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================================================
  # JavaScript Release (Changesets-based)
  # ============================================================================

  prepare-javascript:
    name: Prepare JavaScript Release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    outputs:
      has_changesets: ${{ steps.changeset_status.outputs.has_changesets }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Check for pending changesets
        id: changeset_status
        run: |
          # Check if any changeset files exist (excluding README.md)
          CHANGESET_COUNT=$(find .changeset -name "*.md" -not -name "README.md" | wc -l)

          if [ "$CHANGESET_COUNT" -gt 0 ]; then
            echo "Found $CHANGESET_COUNT changeset file(s) for JavaScript"
            echo "has_changesets=true" >> $GITHUB_OUTPUT
          else
            echo "No changeset files found"
            echo "has_changesets=false" >> $GITHUB_OUTPUT
          fi

  version-pr-javascript:
    name: Create JavaScript Version PR to Main
    needs: prepare-javascript
    runs-on: ubuntu-latest
    if: needs.prepare-javascript.outputs.has_changesets == 'true'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Create Version PR to Main
        id: changesets
        uses: changesets/action@v1
        with:
          version: pnpm changeset:version
          commit: "chore(javascript): version packages"
          title: "chore(javascript): version packages"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  detect-javascript-changes:
    name: Detect JavaScript Version Changes
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/main' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    outputs:
      version_changed: ${{ steps.check_version.outputs.version_changed }}
      version: ${{ steps.check_version.outputs.version }}
      has_changesets: ${{ steps.check_changesets.outputs.has_changesets }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Check for pending changesets
        id: check_changesets
        run: |
          CHANGESET_COUNT=$(find .changeset -name "*.md" -not -name "README.md" | wc -l)
          if [ "$CHANGESET_COUNT" -gt 0 ]; then
            echo "has_changesets=true" >> $GITHUB_OUTPUT
          else
            echo "has_changesets=false" >> $GITHUB_OUTPUT
          fi

      - name: Check JavaScript version changes
        id: check_version
        run: |
          JS_VERSION=$(node -p "require('./packages/javascript/package.json').version")

          # Check if package.json was updated in the last commit OR if workflow_dispatch
          VERSION_IN_COMMIT=$(git diff HEAD~1 HEAD -- packages/javascript/package.json | grep -q '"version"' && echo "true" || echo "false")

          if [ "$VERSION_IN_COMMIT" = "true" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Check if this version has been published to npm
            if npm view nats-pubsub@${JS_VERSION} version 2>/dev/null; then
              echo "version_changed=false" >> $GITHUB_OUTPUT
              echo "JavaScript version $JS_VERSION already published to npm"
            else
              echo "version_changed=true" >> $GITHUB_OUTPUT
              echo "version=$JS_VERSION" >> $GITHUB_OUTPUT
              echo "JavaScript version $JS_VERSION not yet published - will publish"
            fi
          else
            echo "version_changed=false" >> $GITHUB_OUTPUT
            echo "No JavaScript version change detected"
          fi

  publish-javascript:
    name: Publish JavaScript Package
    needs: detect-javascript-changes
    runs-on: ubuntu-latest
    if: |
      needs.detect-javascript-changes.outputs.version_changed == 'true' &&
      needs.detect-javascript-changes.outputs.has_changesets == 'false'
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0

      - name: Setup Node.js with npm registry for OIDC
        uses: actions/setup-node@v6
        with:
          node-version: 24
          registry-url: "https://registry.npmjs.org"
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build and publish to npm with OIDC
        run: |
          cd packages/javascript
          pnpm build
          npm publish --provenance --access public

      - name: Create Git tag
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          TAG_NAME="javascript-v${{ needs.detect-javascript-changes.outputs.version }}"
          if ! git tag | grep -q "^${TAG_NAME}$"; then
            git tag -a "${TAG_NAME}" -m "Release ${TAG_NAME}"
            git push origin "${TAG_NAME}"
            echo "Created and pushed tag ${TAG_NAME}"
          else
            echo "Tag ${TAG_NAME} already exists, skipping tag creation"
          fi

      - name: Create GitHub Release
        run: |
          JS_VERSION="${{ needs.detect-javascript-changes.outputs.version }}"

          gh release create "javascript-v$JS_VERSION" \
            --title "JavaScript v$JS_VERSION" \
            --notes "JavaScript/TypeScript package release v$JS_VERSION

          ## Installation

          \`\`\`bash
          npm install nats-pubsub@$JS_VERSION
          # or
          pnpm add nats-pubsub@$JS_VERSION
          # or
          yarn add nats-pubsub@$JS_VERSION
          \`\`\`

          See the [full changelog](https://github.com/${{ github.repository }}/blob/main/packages/javascript/CHANGELOG.md) for detailed changes."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Ruby Release (Manual versioning)
  # ============================================================================

  detect-ruby-changes:
    name: Detect Ruby Version Changes
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/main' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    outputs:
      version_changed: ${{ steps.check_version.outputs.version_changed }}
      version: ${{ steps.check_version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check Ruby version changes
        id: check_version
        run: |
          RUBY_VERSION=$(sed -n "s/.*VERSION = '\\([^']*\\)'.*/\\1/p" packages/ruby/lib/nats_pubsub/version.rb)

          # Check if version.rb was updated in the last commit OR if workflow_dispatch
          VERSION_IN_COMMIT=$(git diff HEAD~1 HEAD -- packages/ruby/lib/nats_pubsub/version.rb | grep -q 'VERSION' && echo "true" || echo "false")

          if [ "$VERSION_IN_COMMIT" = "true" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Check if this version has been published to RubyGems
            if gem search -r "^nats_pubsub$" --version "${RUBY_VERSION}" | grep -q "nats_pubsub (${RUBY_VERSION})"; then
              echo "version_changed=false" >> $GITHUB_OUTPUT
              echo "Ruby version $RUBY_VERSION already published to RubyGems"
            else
              echo "version_changed=true" >> $GITHUB_OUTPUT
              echo "version=$RUBY_VERSION" >> $GITHUB_OUTPUT
              echo "Ruby version $RUBY_VERSION not yet published - will publish"
            fi
          else
            echo "version_changed=false" >> $GITHUB_OUTPUT
            echo "No Ruby version change detected"
          fi

  publish-ruby:
    name: Publish Ruby Package
    needs: detect-ruby-changes
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/ruby
    if: needs.detect-ruby-changes.outputs.version_changed == 'true'
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ruby
          bundler-cache: true
          working-directory: packages/ruby

      - name: Create Git tag
        working-directory: .
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          TAG_NAME="ruby-v${{ needs.detect-ruby-changes.outputs.version }}"
          if ! git tag | grep -q "^${TAG_NAME}$"; then
            git tag -a "${TAG_NAME}" -m "Release ${TAG_NAME}"
            git push origin "${TAG_NAME}"
            echo "Created and pushed tag ${TAG_NAME}"
          else
            echo "Tag ${TAG_NAME} already exists, skipping tag creation"
          fi

      - name: Configure RubyGems Credentials with OIDC
        uses: rubygems/configure-rubygems-credentials@v1.0.0

      - name: Build and Publish Gem
        working-directory: packages/ruby
        run: |
          gem build nats_pubsub.gemspec
          gem push nats_pubsub-*.gem

      - name: Create GitHub Release
        working-directory: .
        env:
          RUBY_VERSION: ${{ needs.detect-ruby-changes.outputs.version }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "ruby-v${RUBY_VERSION}" \
            --title "Ruby v${RUBY_VERSION}" \
            --notes "Ruby package release v${RUBY_VERSION}

          ## Installation

          \`\`\`ruby
          # Gemfile
          gem 'nats_pubsub', '~> ${RUBY_VERSION}'
          \`\`\`

          Or via command line:
          \`\`\`bash
          gem install nats_pubsub -v ${RUBY_VERSION}
          \`\`\`

          See the [full changelog](https://github.com/${{ github.repository }}/blob/main/packages/ruby/CHANGELOG.md) for detailed changes." \
            packages/ruby/nats_pubsub-*.gem
