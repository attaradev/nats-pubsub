name: Release

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment name for manual approval (e.g., release, production)"
        required: false
        type: string
        default: "release"

permissions:
  contents: write
  pull-requests: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    outputs:
      has_changesets: ${{ steps.changeset_status.outputs.has_changesets }}
      published: ${{ steps.changeset_status.outputs.published }}
      published_packages: ${{ steps.changeset_status.outputs.published_packages }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Check for pending changesets
        id: changeset_status
        run: |
          # Check if any changeset files exist (excluding README.md)
          CHANGESET_COUNT=$(find .changeset -name "*.md" -not -name "README.md" | wc -l)

          if [ "$CHANGESET_COUNT" -gt 0 ]; then
            echo "Found $CHANGESET_COUNT changeset file(s)"
            echo "has_changesets=true" >> $GITHUB_OUTPUT
          else
            echo "No changeset files found"
            echo "has_changesets=false" >> $GITHUB_OUTPUT
          fi

  version-pr:
    name: Create Version PR or Publish
    needs: prepare
    runs-on: ubuntu-latest
    if: needs.prepare.outputs.has_changesets == 'true'
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Create Release PR or Publish Packages
        id: changesets
        uses: changesets/action@v1
        with:
          version: pnpm changeset:version
          publish: pnpm changeset:publish
          commit: "chore: release packages"
          title: "chore: release packages"
          createGithubReleases: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_CONFIG_PROVENANCE: true

      - name: Output published packages
        if: steps.changesets.outputs.published == 'true'
        run: |
          echo "Published packages:"
          echo '${{ steps.changesets.outputs.publishedPackages }}' | jq '.'

      - name: Create GitHub Releases for JavaScript
        if: steps.changesets.outputs.published == 'true'
        run: |
          PUBLISHED='${{ steps.changesets.outputs.publishedPackages }}'

          # Check if nats-pubsub was published
          JS_VERSION=$(echo "$PUBLISHED" | jq -r '.[] | select(.name == "nats-pubsub") | .version')

          if [ -n "$JS_VERSION" ] && [ "$JS_VERSION" != "null" ]; then
            echo "Creating GitHub release for nats-pubsub@$JS_VERSION"

            gh release create "javascript-v$JS_VERSION" \
              --title "JavaScript v$JS_VERSION" \
              --notes "JavaScript/TypeScript package release v$JS_VERSION

            ## Installation

            \`\`\`bash
            npm install nats-pubsub@$JS_VERSION
            # or
            pnpm add nats-pubsub@$JS_VERSION
            # or
            yarn add nats-pubsub@$JS_VERSION
            \`\`\`

            See the [full changelog](https://github.com/${{ github.repository }}/blob/develop/packages/javascript/CHANGELOG.md) for detailed changes." \
              --latest
          else
            echo "No JavaScript package was published in this release"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-ruby:
    name: Release Ruby
    needs: version-pr
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/ruby
    if: |
      always() &&
      needs.version-pr.result == 'success' &&
      github.ref == 'refs/heads/develop'
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ruby
          bundler-cache: true
          working-directory: packages/ruby

      - name: Check if version changed
        id: check_version
        run: |
          RUBY_VERSION=$(sed -n "s/.*VERSION = '\\([^']*\\)'.*/\\1/p" lib/nats_pubsub/version.rb)

          # Check if this version was already released
          if git tag | grep -q "^ruby-v${RUBY_VERSION}$"; then
            echo "version_changed=false" >> $GITHUB_OUTPUT
            echo "Ruby version $RUBY_VERSION already released"
          else
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "ruby_version=$RUBY_VERSION" >> $GITHUB_OUTPUT
            echo "New Ruby version $RUBY_VERSION detected"
          fi

      - name: Create Git tag
        if: steps.check_version.outputs.version_changed == 'true'
        working-directory: .
        env:
          RUBY_VERSION: ${{ steps.check_version.outputs.ruby_version }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git tag -a "ruby-v${RUBY_VERSION}" -m "Release ruby-v${RUBY_VERSION}"
          git push origin "ruby-v${RUBY_VERSION}"

      - name: Publish to RubyGems with OIDC
        if: steps.check_version.outputs.version_changed == 'true'
        uses: rubygems/release-gem@v1

      - name: Create GitHub Release
        if: steps.check_version.outputs.version_changed == 'true'
        working-directory: .
        env:
          RUBY_VERSION: ${{ steps.check_version.outputs.ruby_version }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "ruby-v${RUBY_VERSION}" \
            --title "Ruby v${RUBY_VERSION}" \
            --notes "Ruby package release v${RUBY_VERSION}

          ## Installation

          \`\`\`ruby
          # Gemfile
          gem 'nats_pubsub', '~> ${RUBY_VERSION}'
          \`\`\`

          Or via command line:
          \`\`\`bash
          gem install nats_pubsub -v ${RUBY_VERSION}
          \`\`\`

          See the [full changelog](https://github.com/${{ github.repository }}/blob/develop/packages/ruby/CHANGELOG.md) for detailed changes." \
            packages/ruby/*.gem
