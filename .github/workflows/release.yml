name: Release

on:
  workflow_call:
    inputs:
      environment:
        description: "Environment name to use for manual approval (e.g., release, production)"
        required: false
        type: string
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:
    inputs:
      rollback_version:
        description: "Version to rollback (e.g., 0.2.0)"
        required: false
        type: string
      rollback_package:
        description: "Package to rollback (javascript/ruby)"
        required: false
        type: choice
        options:
          - javascript
          - ruby
      environment:
        description: "Environment name to use for manual approval (e.g., release, production)"
        required: false
        type: string
        default: "release"

permissions:
  contents: write
  pull-requests: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare:
    name: Prepare release inputs
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_call' ||
      (
        github.event_name == 'workflow_run' &&
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.event == 'push' &&
        github.event.workflow_run.head_branch == 'main'
      ) ||
      (
        github.event_name == 'workflow_dispatch' &&
        (github.event.inputs.rollback_version == '' || github.event.inputs.rollback_version == null)
      )
    outputs:
      has_changesets: ${{ steps.changeset_status.outputs.has_changesets }}
      js_version_changed: ${{ steps.js_status.outputs.js_version_changed }}
      js_version: ${{ steps.js_status.outputs.js_version }}
      ruby_changed: ${{ steps.ruby_status.outputs.ruby_changed }}
      ruby_version: ${{ steps.ruby_status.outputs.ruby_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Run security audit (JavaScript)
        id: security_audit_js
        continue-on-error: true
        run: |
          echo "üîí Running JavaScript security audit..."
          echo ""

          pnpm audit --audit-level=high --json > /tmp/npm-audit.json 2>&1 || true

          # Check if the audit output is valid JSON
          if ! jq empty /tmp/npm-audit.json 2>/dev/null; then
            echo "‚ö†Ô∏è  Warning: Could not parse audit results"
            echo "has_vulnerabilities=unknown" >> $GITHUB_OUTPUT
            echo "audit_summary=Could not parse results" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract vulnerability counts
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' /tmp/npm-audit.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' /tmp/npm-audit.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' /tmp/npm-audit.json)
          LOW=$(jq '.metadata.vulnerabilities.low // 0' /tmp/npm-audit.json)
          TOTAL=$(jq '.metadata.vulnerabilities.total // 0' /tmp/npm-audit.json)

          echo "Vulnerability Summary:"
          echo "  Critical: $CRITICAL"
          echo "  High:     $HIGH"
          echo "  Moderate: $MODERATE"
          echo "  Low:      $LOW"
          echo "  Total:    $TOTAL"
          echo ""

          # Generate detailed report
          if [ "$TOTAL" -gt 0 ]; then
            echo "üìã Detailed Vulnerabilities:"
            jq -r '.advisories | to_entries[] | "  - \(.value.title) (Severity: \(.value.severity))\n    Package: \(.value.module_name)\n    Patched: \(.value.patched_versions)"' /tmp/npm-audit.json || true
            echo ""
          fi

          SEVERITY_TOTAL=$((CRITICAL + HIGH))
          if [ "$SEVERITY_TOTAL" -gt 0 ]; then
            echo "‚ö†Ô∏è  Found $SEVERITY_TOTAL high/critical vulnerabilities"
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
            echo "vulnerability_count=$SEVERITY_TOTAL" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ No high/critical vulnerabilities found"
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "vulnerability_count=0" >> $GITHUB_OUTPUT
          fi

          # Create audit summary
          SUMMARY="Critical: $CRITICAL, High: $HIGH, Moderate: $MODERATE, Low: $LOW"
          echo "audit_summary=$SUMMARY" >> $GITHUB_OUTPUT

      - name: Validate package builds
        run: |
          echo "Building JavaScript package..."
          cd packages/javascript
          pnpm build

          # Verify build artifacts exist
          if [ ! -f "dist/index.js" ] || [ ! -f "dist/index.cjs" ]; then
            echo "‚ùå Build artifacts missing"
            exit 1
          fi

          # Verify TypeScript declarations
          if [ ! -f "dist/index.d.ts" ] || [ ! -f "dist/index.d.cts" ]; then
            echo "‚ùå TypeScript declaration files missing"
            exit 1
          fi

          # Check build artifact sizes
          JS_SIZE=$(stat -f%z "dist/index.js" 2>/dev/null || stat -c%s "dist/index.js" 2>/dev/null)
          CJS_SIZE=$(stat -f%z "dist/index.cjs" 2>/dev/null || stat -c%s "dist/index.cjs" 2>/dev/null)

          echo "Build artifact sizes:"
          echo "  - index.js: $(numfmt --to=iec-i --suffix=B $JS_SIZE 2>/dev/null || echo "${JS_SIZE} bytes")"
          echo "  - index.cjs: $(numfmt --to=iec-i --suffix=B $CJS_SIZE 2>/dev/null || echo "${CJS_SIZE} bytes")"

          # Verify package.json exports match build artifacts
          if ! node -e "require('./package.json').exports" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Warning: Could not validate package.json exports"
          fi

          echo "‚úÖ JavaScript build successful"

      - name: Check for pending changesets
        id: changeset_status
        run: |
          # First check if any changeset files exist (excluding README.md)
          CHANGESET_COUNT=$(find .changeset -name "*.md" -not -name "README.md" | wc -l)

          if [ "$CHANGESET_COUNT" -eq 0 ]; then
            echo "No changeset files found in .changeset directory"
            echo "has_changesets=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found $CHANGESET_COUNT changeset file(s), checking status..."

          set +e
          pnpm changeset status --output=json > /tmp/changeset-status.json 2>&1
          STATUS=$?
          set -e

          if [ $STATUS -ne 0 ]; then
            echo "Warning: changeset status command exited with code $STATUS"
            cat /tmp/changeset-status.json
            echo "has_changesets=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Validate that the file contains valid JSON
          if ! jq empty /tmp/changeset-status.json 2>/dev/null; then
            echo "Invalid JSON output from changeset status:"
            cat /tmp/changeset-status.json
            echo "has_changesets=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          COUNT=$(jq '.releases | length' /tmp/changeset-status.json)
          if [ "$COUNT" -gt 0 ]; then
            echo "Found $COUNT pending changeset release(s)"
            echo "has_changesets=true" >> $GITHUB_OUTPUT
          else
            echo "No pending changesets to release"
            echo "has_changesets=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect JavaScript version change
        id: js_status
        run: |
          BEFORE="${{ github.event.before || '' }}"
          AFTER="${{ github.sha }}"

          if [ -n "$BEFORE" ] && [ "$BEFORE" != "0000000000000000000000000000000000000000" ]; then
            RANGE="${BEFORE}..${AFTER}"
          elif git rev-parse HEAD~1 >/dev/null 2>&1; then
            RANGE="HEAD~1..HEAD"
          else
            RANGE=""
          fi

          JS_VERSION_CHANGED=false
          JS_VERSION=""

          if [ -f "packages/javascript/package.json" ]; then
            if [ -n "$RANGE" ]; then
              CHANGED=$(git diff --name-only "$RANGE" -- packages/javascript/package.json || true)
            else
              CHANGED=$(git show --name-only --pretty="" "$AFTER" -- packages/javascript/package.json || true)
            fi

            if echo "$CHANGED" | grep -q "packages/javascript/package.json"; then
              JS_VERSION_CHANGED=true
              JS_VERSION=$(node -p "require('./packages/javascript/package.json').version")
              echo "JavaScript package version changed to $JS_VERSION"
            else
              echo "No JavaScript version change detected"
            fi
          fi

          echo "js_version_changed=${JS_VERSION_CHANGED}" >> $GITHUB_OUTPUT
          echo "js_version=${JS_VERSION}" >> $GITHUB_OUTPUT

      - name: Detect Ruby version change
        id: ruby_status
        run: |
          BEFORE="${{ github.event.before || '' }}"
          AFTER="${{ github.sha }}"

          if [ -n "$BEFORE" ] && [ "$BEFORE" != "0000000000000000000000000000000000000000" ]; then
            RANGE="${BEFORE}..${AFTER}"
          elif git rev-parse HEAD~1 >/dev/null 2>&1; then
            RANGE="HEAD~1..HEAD"
          else
            RANGE=""
          fi

          if [ -n "$RANGE" ]; then
            CHANGED=$(git diff --name-only "$RANGE" -- packages/ruby/lib/nats_pubsub/version.rb || true)
          else
            CHANGED=$(git show --name-only --pretty="" "$AFTER" -- packages/ruby/lib/nats_pubsub/version.rb || true)
          fi

          if echo "$CHANGED" | grep -q "packages/ruby/lib/nats_pubsub/version.rb"; then
            echo "Ruby version file changed"
            RUBY_CHANGED=true
            RUBY_VERSION=$(sed -n "s/.*VERSION = '\\([^']*\\)'.*/\\1/p" packages/ruby/lib/nats_pubsub/version.rb)
          else
            echo "No Ruby version changes detected"
            RUBY_CHANGED=false
            RUBY_VERSION=""
          fi

          echo "ruby_changed=${RUBY_CHANGED}" >> $GITHUB_OUTPUT
          echo "ruby_version=${RUBY_VERSION}" >> $GITHUB_OUTPUT

      - name: Validate Ruby version (if changed)
        if: steps.ruby_status.outputs.ruby_changed == 'true'
        run: |
          echo "Validating Ruby version..."
          ./scripts/ruby-version-sync.sh

      - name: Pre-release validation summary
        run: |
          echo ""
          echo "========================================"
          echo "üìã Pre-Release Validation Summary"
          echo "========================================"
          echo ""
          echo "üîí Security Audit (JavaScript):"
          echo "  Status: ${{ steps.security_audit_js.outcome }}"
          echo "  Summary: ${{ steps.security_audit_js.outputs.audit_summary || 'No vulnerabilities' }}"
          if [ "${{ steps.security_audit_js.outputs.has_vulnerabilities }}" = "true" ]; then
            echo "  ‚ö†Ô∏è  High/Critical: ${{ steps.security_audit_js.outputs.vulnerability_count }}"
            echo "  Action: Review vulnerabilities before release"
          else
            echo "  ‚úÖ No critical vulnerabilities found"
          fi
          echo ""
          echo "üèóÔ∏è  Build Validation:"
          echo "  JavaScript: ‚úÖ Passed"
          echo "  Artifacts: ‚úÖ Verified"
          echo "  Type Definitions: ‚úÖ Present"
          echo ""
          echo "üì¶ Release Status:"
          echo "  Has Changesets: ${{ steps.changeset_status.outputs.has_changesets }}"
          echo "  JS Version Changed: ${{ steps.js_status.outputs.js_version_changed }}"
          if [ "${{ steps.js_status.outputs.js_version_changed }}" = "true" ]; then
            echo "  JavaScript Version: ${{ steps.js_status.outputs.js_version }}"
          fi
          echo "  Ruby Changes: ${{ steps.ruby_status.outputs.ruby_changed }}"
          if [ "${{ steps.ruby_status.outputs.ruby_changed }}" = "true" ]; then
            echo "  Ruby Version: ${{ steps.ruby_status.outputs.ruby_version }}"
          fi
          echo ""
          echo "========================================"
          echo "‚úÖ Pre-release validation completed"
          echo "========================================"
          echo ""

  approval:
    name: Await manual approval
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.js_version_changed == 'true' || needs.prepare.outputs.ruby_changed == 'true'
    environment:
      name: ${{ inputs.environment || github.event.inputs.environment || 'release' }}
      url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Manual approval required
        run: |
          echo "This job requires manual approval via the protected 'release' environment before publishing."

  release-pr:
    name: Create Version Packages PR (JS)
    needs: prepare
    runs-on: ubuntu-latest
    if: needs.prepare.outputs.has_changesets == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Create Version Packages PR
        id: changesets_pr
        uses: changesets/action@v1
        with:
          version: pnpm changeset:version
          commit: "chore: version packages"
          title: "chore: version packages"
          createGithubReleases: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_CONFIG_PROVENANCE: true

  release:
    name: Publish JavaScript (JS)
    needs:
      - prepare
      - approval
    runs-on: ubuntu-latest
    if: needs.prepare.outputs.js_version_changed == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Create Release PR or Publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          version: pnpm changeset:version
          publish: pnpm changeset:publish
          commit: "chore: version packages"
          title: "chore: version packages"
          createGithubReleases: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_CONFIG_PROVENANCE: true

      - name: Get published packages info
        id: packages
        if: steps.changesets.outputs.published == 'true'
        run: |
          echo "Published packages:"
          echo '${{ steps.changesets.outputs.publishedPackages }}' | jq .

          # Extract JavaScript package version if published
          JS_VERSION=$(echo '${{ steps.changesets.outputs.publishedPackages }}' | jq -r '.[] | select(.name == "nats-pubsub") | .version')
          echo "js_version=$JS_VERSION" >> $GITHUB_OUTPUT
          echo "JavaScript version: $JS_VERSION"

      - name: Generate release notes
        id: release_notes
        if: steps.changesets.outputs.published == 'true' && steps.packages.outputs.js_version != ''
        run: |
          cd packages/javascript

          # Extract changelog entry for this version
          VERSION="${{ steps.packages.outputs.js_version }}"
          echo "Extracting changelog for version $VERSION..."

          # Create release notes
          cat > /tmp/release-notes.md << 'NOTES'
          ## What's Changed

          See the [full changelog](https://github.com/${{ github.repository }}/blob/main/packages/javascript/CHANGELOG.md#$(echo $VERSION | sed 's/\.//g')) for detailed changes.

          ## Installation

          ```bash
          npm install nats-pubsub@$VERSION
          # or
          pnpm add nats-pubsub@$VERSION
          # or
          yarn add nats-pubsub@$VERSION
          ```

          ## Package Details

          - **Size**: $(npm view nats-pubsub@$VERSION dist.unpackedSize 2>/dev/null || echo "calculating...")
          - **Dependencies**: $(cat package.json | jq -r '.dependencies | keys | length') direct dependencies
          - **Node.js**: >= 20.0.0
          - **TypeScript**: Full type definitions included

          ## Verification

          This release includes [npm provenance](https://docs.npmjs.com/generating-provenance-statements) for supply chain security.

          ```bash
          # Verify package authenticity
          npm view nats-pubsub@$VERSION
          ```
          NOTES

          echo "release_notes_path=/tmp/release-notes.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release for JavaScript
        if: steps.changesets.outputs.published == 'true' && steps.packages.outputs.js_version != ''
        uses: softprops/action-gh-release@v2.4.2
        with:
          tag_name: javascript-v${{ steps.packages.outputs.js_version }}
          name: JavaScript v${{ steps.packages.outputs.js_version }}
          body_path: ${{ steps.release_notes.outputs.release_notes_path }}
          draft: false
          prerelease: false
          generate_release_notes: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify npm publication
        if: steps.changesets.outputs.published == 'true' && steps.packages.outputs.js_version != ''
        run: |
          echo "Waiting 10 seconds for npm registry propagation..."
          sleep 10

          VERSION="${{ steps.packages.outputs.js_version }}"

          # Verify package exists
          if ! npm view nats-pubsub@$VERSION >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Warning: Package not found on npm registry yet. This might be expected if there was a publication delay."
            exit 0
          fi

          echo "‚úÖ Package found on npm registry"
          echo ""

          # Verify package metadata
          echo "üì¶ Verifying package metadata..."
          PUBLISHED_VERSION=$(npm view nats-pubsub@$VERSION version)
          if [ "$PUBLISHED_VERSION" != "$VERSION" ]; then
            echo "‚ùå Version mismatch: expected $VERSION, got $PUBLISHED_VERSION"
            exit 1
          fi
          echo "  Version: ‚úÖ $PUBLISHED_VERSION"

          # Check package size
          SIZE=$(npm view nats-pubsub@$VERSION dist.unpackedSize)
          SIZE_MB=$(echo "scale=2; $SIZE / 1024 / 1024" | bc)
          echo "  Size: $SIZE bytes (~${SIZE_MB}MB)"

          # Verify critical package.json fields
          echo ""
          echo "üîç Verifying package integrity..."
          MAIN=$(npm view nats-pubsub@$VERSION main)
          MODULE=$(npm view nats-pubsub@$VERSION module)
          TYPES=$(npm view nats-pubsub@$VERSION types)
          echo "  Main: $MAIN"
          echo "  Module: $MODULE"
          echo "  Types: $TYPES"

          # Verify provenance (NPM_CONFIG_PROVENANCE was set during publish)
          echo ""
          echo "üîê Verifying provenance..."
          if npm view nats-pubsub@$VERSION --json | jq -e '.dist.attestations' >/dev/null 2>&1; then
            echo "  ‚úÖ Provenance attestations found"
            npm view nats-pubsub@$VERSION --json | jq '.dist.attestations' || true
          else
            echo "  ‚ö†Ô∏è  Warning: No provenance attestations found"
          fi

          # Verify package contains expected files
          echo ""
          echo "üìÅ Verifying package contents..."
          FILES=$(npm view nats-pubsub@$VERSION files --json | jq -r '.[]' | wc -l)
          echo "  Files included: $FILES"
          npm view nats-pubsub@$VERSION files --json | jq -r '.[]' | head -10

          # Check dependencies
          echo ""
          echo "üìö Dependencies:"
          npm view nats-pubsub@$VERSION dependencies --json | jq .

          echo ""
          echo "‚úÖ Package successfully published and verified on npm"

      - name: Test package installation
        if: steps.changesets.outputs.published == 'true' && steps.packages.outputs.js_version != ''
        run: |
          echo "Testing package installation..."
          mkdir -p /tmp/test-install
          cd /tmp/test-install
          npm init -y
          npm install nats-pubsub@${{ steps.packages.outputs.js_version }}

          # Verify installation
          if [ ! -d "node_modules/nats-pubsub" ]; then
            echo "‚ùå Package installation failed"
            exit 1
          fi

          echo "‚úì Package installs successfully"

      - name: Notify release success
        if: steps.changesets.outputs.published == 'true' && steps.packages.outputs.js_version != ''
        uses: actions/github-script@v8
        with:
          script: |
            const version = '${{ steps.packages.outputs.js_version }}';
            const releaseUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/javascript-v${version}`;
            const npmUrl = `https://www.npmjs.com/package/nats-pubsub/v/${version}`;

            // Create a discussion or comment (optional - can be configured)
            console.log(`‚úÖ JavaScript package v${version} released successfully!`);
            console.log(`üì¶ npm: ${npmUrl}`);
            console.log(`üè∑Ô∏è  GitHub Release: ${releaseUrl}`);

            // You can add additional notifications here:
            // - Post to Discord/Slack webhook
            // - Send email
            // - Create GitHub Discussion
            // - Update documentation

            // Example: Create a release announcement discussion
            try {
              const discussion = await github.rest.discussions.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                category_id: 'announcements', // You'll need to configure this
                title: `üöÄ nats-pubsub v${version} Released`,
                body: `We're excited to announce the release of nats-pubsub v${version}!

                ## Installation

                \`\`\`bash
                npm install nats-pubsub@${version}
                # or
                pnpm add nats-pubsub@${version}
                # or
                yarn add nats-pubsub@${version}
                \`\`\`

                ## Links

                - üì¶ [npm Package](${npmUrl})
                - üè∑Ô∏è  [GitHub Release](${releaseUrl})
                - üìñ [Changelog](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/packages/javascript/CHANGELOG.md)

                Thank you to all contributors! üéâ`
              });
              console.log(`Created discussion: ${discussion.data.html_url}`);
            } catch (error) {
              console.log('Note: Could not create discussion (this is optional):', error.message);
            }

  release-ruby:
    name: Release Ruby Package
    runs-on: ubuntu-latest
    needs:
      - prepare
      - approval
    if: needs.prepare.outputs.ruby_changed == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true
          working-directory: packages/ruby
          rubygems: latest

      - name: Run security audit (Ruby)
        continue-on-error: true
        run: |
          cd packages/ruby
          echo "Installing bundler-audit..."
          gem install bundler-audit

          echo "Updating vulnerability database..."
          bundle audit update

          echo "Running security audit..."
          bundle audit check --verbose || {
            echo "‚ö†Ô∏è Security vulnerabilities found in Ruby dependencies"
            echo "Review and address before releasing if critical"
          }

      - name: Validate gem build
        env:
          RUBY_VERSION: ${{ needs.prepare.outputs.ruby_version }}
        run: |
          cd packages/ruby
          echo "Building gem..."
          gem build nats_pubsub.gemspec

          # Verify gem was created
          if [ ! -f "nats_pubsub-${RUBY_VERSION}.gem" ]; then
            echo "‚ùå Gem build failed"
            exit 1
          fi
          echo "‚úÖ Gem built successfully: nats_pubsub-${RUBY_VERSION}.gem"

      - name: Check if tag exists
        id: check_tag
        env:
          RUBY_VERSION: ${{ needs.prepare.outputs.ruby_version }}
        run: |
          if git rev-parse "ruby-v${RUBY_VERSION}" >/dev/null 2>&1; then
            echo "Tag ruby-v${RUBY_VERSION} already exists"
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "Tag does not exist, will create it"
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Git tag
        if: steps.check_tag.outputs.tag_exists == 'false'
        env:
          RUBY_VERSION: ${{ needs.prepare.outputs.ruby_version }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git tag -a "ruby-v${RUBY_VERSION}" -m "Release ruby-v${RUBY_VERSION} [skip ci]"
          git push origin "ruby-v${RUBY_VERSION}"

      - name: Build gem
        env:
          RUBY_VERSION: ${{ needs.prepare.outputs.ruby_version }}
        run: |
          cd packages/ruby
          gem build nats_pubsub.gemspec

      - name: Publish to RubyGems
        env:
          RUBY_VERSION: ${{ needs.prepare.outputs.ruby_version }}
        run: |
          cd packages/ruby
          gem push *.gem --oidc

      - name: Verify RubyGems publication
        env:
          RUBY_VERSION: ${{ needs.prepare.outputs.ruby_version }}
        run: |
          echo "Waiting 15 seconds for RubyGems propagation..."
          sleep 15

          # Verify gem exists
          gem list -r nats_pubsub | grep "nats_pubsub (${RUBY_VERSION})" || {
            echo "Warning: Gem not found on RubyGems yet. This might be expected if there was a publication delay."
            exit 0
          }

          # Verify gem info
          echo "Verifying gem metadata..."
          gem info nats_pubsub -r --version ${RUBY_VERSION} || true

          echo "‚úì Gem successfully published and available on RubyGems"

      - name: Test gem installation
        env:
          RUBY_VERSION: ${{ needs.prepare.outputs.ruby_version }}
        run: |
          echo "Testing gem installation..."
          gem install nats_pubsub -v ${RUBY_VERSION}

          # Verify installation
          if ! gem list -i nats_pubsub -v ${RUBY_VERSION} >/dev/null 2>&1; then
            echo "‚ùå Gem installation failed"
            exit 1
          fi

          echo "‚úì Gem installs successfully"

      - name: Create GitHub Release for Ruby
        uses: softprops/action-gh-release@v2.4.2
        env:
          RUBY_VERSION: ${{ needs.prepare.outputs.ruby_version }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ruby-v${{ env.RUBY_VERSION }}
          name: Ruby v${{ env.RUBY_VERSION }}
          body: |
            Ruby package release v${{ env.RUBY_VERSION }}

            See [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/packages/ruby/CHANGELOG.md) for details.

            ## Installation

            ```ruby
            # Gemfile
            gem 'nats_pubsub', '~> ${{ env.RUBY_VERSION }}'
            ```

            Or via command line:
            ```bash
            gem install nats_pubsub -v ${{ env.RUBY_VERSION }}
            ```
          files: packages/ruby/*.gem
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: Notify Ruby release success
        uses: actions/github-script@v8
        env:
          RUBY_VERSION: ${{ needs.prepare.outputs.ruby_version }}
        with:
          script: |
            const version = process.env.RUBY_VERSION;
            const releaseUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/ruby-v${version}`;
            const gemsUrl = `https://rubygems.org/gems/nats_pubsub/versions/${version}`;

            console.log(`‚úÖ Ruby gem v${version} released successfully!`);
            console.log(`üíé RubyGems: ${gemsUrl}`);
            console.log(`üè∑Ô∏è  GitHub Release: ${releaseUrl}`);

            // Optional: Create a release announcement
            try {
              const discussion = await github.rest.discussions.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                category_id: 'announcements',
                title: `üíé nats_pubsub (Ruby) v${version} Released`,
                body: `We're excited to announce the release of the Ruby gem nats_pubsub v${version}!

                ## Installation

                \`\`\`ruby
                # In your Gemfile
                gem 'nats_pubsub', '~> ${version}'
                \`\`\`

                Or install directly:

                \`\`\`bash
                gem install nats_pubsub -v ${version}
                \`\`\`

                ## Links

                - üíé [RubyGems Package](${gemsUrl})
                - üè∑Ô∏è  [GitHub Release](${releaseUrl})
                - üìñ [Changelog](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/packages/ruby/CHANGELOG.md)

                Thank you to all contributors! üéâ`
              });
              console.log(`Created discussion: ${discussion.data.html_url}`);
            } catch (error) {
              console.log('Note: Could not create discussion (this is optional):', error.message);
            }

  rollback:
    name: Rollback Release (Manual)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.rollback_version != ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Validate rollback request
        run: |
          VERSION="${{ github.event.inputs.rollback_version }}"
          PACKAGE="${{ github.event.inputs.rollback_package }}"

          echo "üîÑ Rollback Request"
          echo "==================="
          echo "Package: $PACKAGE"
          echo "Version: $VERSION"
          echo ""

          if [ -z "$VERSION" ] || [ -z "$PACKAGE" ]; then
            echo "‚ùå Error: Version and package must be specified"
            exit 1
          fi

          # Verify tag exists
          TAG_NAME="${PACKAGE}-v${VERSION}"
          if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ùå Error: Tag $TAG_NAME does not exist"
            exit 1
          fi

          echo "‚úÖ Tag $TAG_NAME exists"
          echo "‚ö†Ô∏è  WARNING: This will deprecate the npm package (cannot unpublish)"
          echo "   Ruby gems cannot be unpublished from RubyGems"

      - name: Deprecate npm package (JavaScript only)
        if: github.event.inputs.rollback_package == 'javascript'
        run: |
          VERSION="${{ github.event.inputs.rollback_version }}"

          echo "Deprecating nats-pubsub@$VERSION on npm..."
          echo "‚ö†Ô∏è  Note: This requires NPM_TOKEN to be set"

          # This would require NPM_TOKEN with appropriate permissions
          # npm deprecate "nats-pubsub@$VERSION" "This version has been rolled back due to critical issues. Please upgrade to the latest version."

          echo "‚ö†Ô∏è  Manual action required:"
          echo "   Run: npm deprecate nats-pubsub@$VERSION \"Rolled back due to issues\""

      - name: Create rollback issue
        uses: actions/github-script@v8
        with:
          script: |
            const version = '${{ github.event.inputs.rollback_version }}';
            const package = '${{ github.event.inputs.rollback_package }}';

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Rollback: ${package} v${version}`,
              body: `## Rollback Request

              **Package:** ${package}
              **Version:** ${version}
              **Initiated by:** @${context.actor}
              **Workflow:** ${context.workflow}

              ### Required Actions

              ${package === 'javascript' ? `
              - [ ] Deprecate npm package: \`npm deprecate nats-pubsub@${version} "Rolled back"\`
              - [ ] Verify deprecation: \`npm view nats-pubsub@${version}\`
              ` : ''}

              ${package === 'ruby' ? `
              - [ ] Contact RubyGems support to yank gem (if within 24 hours)
              - [ ] Update documentation warning users about this version
              ` : ''}

              - [ ] Delete GitHub release tag: \`${package}-v${version}\`
              - [ ] Update CHANGELOG.md to document the rollback
              - [ ] Investigate root cause
              - [ ] Create new release with fixes

              ### Notes

              - npm packages cannot be unpublished after 72 hours
              - RubyGems can only be yanked within certain time limits
              - GitHub releases and tags can be deleted

              cc: @${context.actor}`,
              labels: ['release', 'rollback', 'urgent']
            });

            console.log(`Created issue #${issue.data.number}`);

      - name: Rollback summary
        run: |
          echo ""
          echo "================================"
          echo "üîÑ Rollback Summary"
          echo "================================"
          echo ""
          echo "Package: ${{ github.event.inputs.rollback_package }}"
          echo "Version: ${{ github.event.inputs.rollback_version }}"
          echo ""
          echo "‚ö†Ô∏è  Manual steps required - see issue created above"
          echo ""
          echo "Next steps:"
          echo "1. Review the created issue for manual actions"
          echo "2. Deprecate the package on the registry"
          echo "3. Delete the GitHub release and tag if needed"
          echo "4. Investigate and fix the issue"
          echo "5. Create a new release with fixes"
          echo ""
