name: Ruby Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (required)"
        required: true
        type: string
      dry_run:
        description: "Dry run (skip publishing)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true
          working-directory: packages/ruby
          rubygems: latest

      - name: Update version
        run: |
          cd packages/ruby
          sed -i.bak "s/VERSION = '[^']*'/VERSION = '${{ github.event.inputs.version }}'/" lib/nats_pubsub/version.rb
          rm -f lib/nats_pubsub/version.rb.bak

      - name: Commit version bump
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add packages/ruby/lib/nats_pubsub/version.rb
          git commit -m "chore(ruby): release v${{ github.event.inputs.version }} [skip ci]"
          git tag -a "ruby-v${{ github.event.inputs.version }}" -m "Release ruby-v${{ github.event.inputs.version }} [skip ci]"
          git push origin ${{ github.ref_name }} --tags

      - name: Dry run summary
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "ğŸƒ DRY RUN MODE - No changes will be published"
          echo "Would release version: ${{ github.event.inputs.version }}"

      - name: Build gem
        run: |
          cd packages/ruby
          gem build nats_pubsub.gemspec

      - name: Publish to RubyGems
        if: github.event.inputs.dry_run != 'true'
        run: |
          cd packages/ruby
          gem push *.gem

      - name: Verify RubyGems publication
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "â³ Waiting 15 seconds for RubyGems propagation..."
          sleep 15
          if gem list -r nats_pubsub | grep "nats_pubsub (${{ github.event.inputs.version }})"; then
            echo "âœ… Gem successfully published"
          else
            echo "âš ï¸  Gem not found on RubyGems yet"
            exit 0
          fi

      - name: Create GitHub Release
        if: github.event.inputs.dry_run != 'true'
        uses: softprops/action-gh-release@v2.4.2
        with:
          tag_name: ruby-v${{ github.event.inputs.version }}
          name: Ruby v${{ github.event.inputs.version }}
          body: |
            Ruby package release v${{ github.event.inputs.version }}

            ## Installation

            ```ruby
            gem 'nats_pubsub', '~> ${{ github.event.inputs.version }}'
            ```
          files: packages/ruby/*.gem
          draft: false
          prerelease: false
