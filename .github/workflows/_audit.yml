name: Security Audit (Reusable)

on:
  workflow_call:
    inputs:
      package:
        description: Package to audit (javascript or ruby)
        required: true
        type: string
      fail-on-vulnerabilities:
        description: Fail the workflow if vulnerabilities are found
        required: false
        type: boolean
        default: true
    outputs:
      has-vulnerabilities:
        description: Whether vulnerabilities were found
        value: ${{ jobs.audit.outputs.has_vulnerabilities }}
      vulnerability-summary:
        description: Summary of vulnerabilities found
        value: ${{ jobs.audit.outputs.vulnerability_summary }}

permissions:
  contents: read

jobs:
  audit:
    name: Audit ${{ inputs.package }} Dependencies
    runs-on: ubuntu-latest
    outputs:
      has_vulnerabilities: ${{ steps.audit.outputs.has_vulnerabilities }}
      vulnerability_summary: ${{ steps.audit.outputs.vulnerability_summary }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      # JavaScript audit
      - name: Setup Node.js and pnpm
        if: inputs.package == 'javascript'
        uses: ./.github/actions/setup-node-pnpm

      - name: Run npm audit (JavaScript)
        if: inputs.package == 'javascript'
        id: audit-js
        continue-on-error: true
        run: |
          echo "ğŸ”’ Running JavaScript security audit..."
          pnpm audit --audit-level=high --json > /tmp/npm-audit.json 2>&1 || true

          # Check if the audit output is valid JSON
          if ! jq empty /tmp/npm-audit.json 2>/dev/null; then
            echo "âš ï¸  Warning: Could not parse audit results"
            echo "has_vulnerabilities=unknown" >> $GITHUB_OUTPUT
            echo "vulnerability_summary=Could not parse results" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract vulnerability counts
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' /tmp/npm-audit.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' /tmp/npm-audit.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' /tmp/npm-audit.json)
          LOW=$(jq '.metadata.vulnerabilities.low // 0' /tmp/npm-audit.json)
          TOTAL=$(jq '.metadata.vulnerabilities.total // 0' /tmp/npm-audit.json)

          echo "Vulnerability Summary:"
          echo "  Critical: $CRITICAL"
          echo "  High:     $HIGH"
          echo "  Moderate: $MODERATE"
          echo "  Low:      $LOW"
          echo "  Total:    $TOTAL"
          echo ""

          # Generate detailed report
          if [ "$TOTAL" -gt 0 ]; then
            echo "ğŸ“‹ Detailed Vulnerabilities:"
            jq -r '.advisories | to_entries[] | "  - \(.value.title) (Severity: \(.value.severity))\n    Package: \(.value.module_name)\n    Patched: \(.value.patched_versions)"' /tmp/npm-audit.json || true
            echo ""
          fi

          SEVERITY_TOTAL=$((CRITICAL + HIGH))
          SUMMARY="Critical: $CRITICAL, High: $HIGH, Moderate: $MODERATE, Low: $LOW"

          if [ "$SEVERITY_TOTAL" -gt 0 ]; then
            echo "âš ï¸  Found $SEVERITY_TOTAL high/critical vulnerabilities"
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
            echo "vulnerability_summary=$SUMMARY" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… No high/critical vulnerabilities found"
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "vulnerability_summary=$SUMMARY" >> $GITHUB_OUTPUT
          fi

      # Ruby audit
      - name: Setup Ruby
        if: inputs.package == 'ruby'
        uses: ./.github/actions/setup-ruby

      - name: Install bundler-audit
        if: inputs.package == 'ruby'
        run: gem install bundler-audit

      - name: Update vulnerability database
        if: inputs.package == 'ruby'
        run: bundle audit update

      - name: Run bundle audit (Ruby)
        if: inputs.package == 'ruby'
        id: audit-rb
        continue-on-error: true
        working-directory: packages/ruby
        run: |
          echo "ğŸ”’ Running Ruby security audit..."
          bundle audit check --format json > /tmp/ruby-audit.json || true

          # Check if vulnerabilities found
          if grep -q '"vulnerabilities":' /tmp/ruby-audit.json; then
            VULN_COUNT=$(jq '.vulnerabilities | length' /tmp/ruby-audit.json || echo "unknown")
            echo "âš ï¸  Found vulnerabilities in Ruby dependencies"
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
            echo "vulnerability_summary=Found $VULN_COUNT vulnerabilities" >> $GITHUB_OUTPUT

            # Show vulnerability details
            echo "ğŸ“‹ Detailed Vulnerabilities:"
            jq -r '.vulnerabilities[] | "  - \(.title) (Severity: \(.severity // "unknown"))\n    Gem: \(.gem)\n    Patched: \(.patched_versions // "N/A")"' /tmp/ruby-audit.json || true

            exit 1
          else
            echo "âœ… No vulnerabilities found"
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "vulnerability_summary=No vulnerabilities found" >> $GITHUB_OUTPUT
          fi

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: ${{ inputs.package }}-audit-results
          path: /tmp/*-audit.json
          retention-days: 30

      - name: Set combined audit output
        id: audit
        if: always()
        run: |
          if [ "${{ inputs.package }}" = "javascript" ]; then
            echo "has_vulnerabilities=${{ steps.audit-js.outputs.has_vulnerabilities }}" >> $GITHUB_OUTPUT
            echo "vulnerability_summary=${{ steps.audit-js.outputs.vulnerability_summary }}" >> $GITHUB_OUTPUT
          else
            echo "has_vulnerabilities=${{ steps.audit-rb.outputs.has_vulnerabilities }}" >> $GITHUB_OUTPUT
            echo "vulnerability_summary=${{ steps.audit-rb.outputs.vulnerability_summary }}" >> $GITHUB_OUTPUT
          fi

      - name: Fail if vulnerabilities found
        if: inputs.fail-on-vulnerabilities && steps.audit.outputs.has_vulnerabilities == 'true'
        run: |
          echo "âŒ Security vulnerabilities found - failing build"
          exit 1
