name: Security Audit

on:
  schedule:
    # Run weekly on Mondays at 9:00 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:
  pull_request:
    branches: [main]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  audit-javascript:
    name: Audit JavaScript
    uses: ./.github/workflows/_audit.yml
    with:
      package: javascript
      fail-on-vulnerabilities: true

  audit-ruby:
    name: Audit Ruby
    uses: ./.github/workflows/_audit.yml
    with:
      package: ruby
      fail-on-vulnerabilities: true

  comment-on-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [audit-javascript, audit-ruby]
    if: failure() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Comment on PR with results
        uses: actions/github-script@v8
        with:
          script: |
            const jsVulns = '${{ needs.audit-javascript.outputs.has-vulnerabilities }}';
            const rbVulns = '${{ needs.audit-ruby.outputs.has-vulnerabilities }}';
            const jsSummary = '${{ needs.audit-javascript.outputs.vulnerability-summary }}';
            const rbSummary = '${{ needs.audit-ruby.outputs.vulnerability-summary }}';

            let body = `## üîí Security Audit Results\n\n`;

            if (jsVulns === 'true') {
              body += `### JavaScript\n‚ö†Ô∏è Vulnerabilities detected:\n- ${jsSummary}\n\nRun \`pnpm audit\` locally for more details.\n\n`;
            }

            if (rbVulns === 'true') {
              body += `### Ruby\n‚ö†Ô∏è Vulnerabilities detected:\n- ${rbSummary}\n\nRun \`bundle audit check\` locally for more details.\n\n`;
            }

            body += `\nPlease review and address these vulnerabilities before merging.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  summary:
    name: Audit Summary
    runs-on: ubuntu-latest
    needs: [audit-javascript, audit-ruby]
    if: always()

    steps:
      - name: Check audit status
        run: |
          JS_STATUS="${{ needs.audit-javascript.result }}"
          RUBY_STATUS="${{ needs.audit-ruby.result }}"

          echo "JavaScript audit: $JS_STATUS"
          echo "Ruby audit: $RUBY_STATUS"

          if [ "$JS_STATUS" = "failure" ] || [ "$RUBY_STATUS" = "failure" ]; then
            echo "‚ùå Security vulnerabilities found"
            exit 1
          else
            echo "‚úÖ No security vulnerabilities found"
          fi
